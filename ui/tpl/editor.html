<button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">
    Open File
</button>
  
  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasExampleLabel">Directory</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div id="directory"></div>
    </div>
  </div>

  <div class="card text-bg-dark mb-3">
    <div class="card-header">Raise custom event</div>
    <div class="card-body">
        <textarea id='editor' style="width:100%"></textarea>
        <button onclick="editorSaveFile()">Save</button>
        
    </div>
    <div class="card-footer" style="font-size: 12px;">
        Triggers an event for all running apps. Please note that this panel only supports STRING as payload. In code, you can use any datatype/object.
    </div>    
</div>      



<script>
    var _active_file = false;

    var editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
        mode: "python",
        lineNumbers: true,
        indentUnit: 4,
        matchBrackets: true
    });
    editor.save()

    
    function buildtree(tree, depth=0, path = '') {
        var html = ''
        if (depth == 0) {
            html += ('<ul id="collapsedirectory">')
        } else {
            html += ('<ul>')
        }
        
        for (name in tree) {
            html += ('<li>')
            if (tree[name]) {
                html += (name);
                html += buildtree(tree[name], depth+1, name+'/')
            } else {
                html += '<a href="#" onclick="editorLoadFile(\''+path + name+'\')" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample">'+name+'</a>'
            }
            html += ('</li>')
        }
        html += ('</ul>')
        return html;
    } 

    api_request('getrepodetails', {'name': _active_repo}, function(response) {
        setTitle('[EDIT] ' + response.DATA.config.app.name);
    });

    api_request('getdirectory', {'name': _active_repo}, function(response) {
        $('#directory').html(buildtree(response.DATA));
        compactMenu('collapsedirectory',false,'&plusmn; ');
    })

    function editorLoadFile(path) {
        _active_file = path;
        api_request('getfilecontent', {'name': _active_repo, 'path': path}, function(response) {
            editor.getDoc().setValue(response.DATA);
        })
    }

    function editorSaveFile() {
        api_request('savefilecontent', {'name': _active_repo, 'path': _active_file, 'content':editor.getValue()}, function(response) {
        })
    }

</script>