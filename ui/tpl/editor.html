<button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">
    File Explorer
</button>
  
  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasExampleLabel">File-Explorer</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div id="directory"></div>
    </div>
  </div>

  <div class="card text-bg-dark mb-3 d-none" id="editorholder">
    <div class="card-header">
        <div class="btn-group" role="group" aria-label="Basic example">
            <button onclick="editorSaveFile()" class="btn btn-primary btn-sm">Save</button>
            <button onclick="" class="btn btn-secondary btn-sm">New</button>

        </div>

    </div>

    <ul class="nav nav-tabs" id="editor_tabbar"></ul>

    <div class="card-body">
        <div class="tab-content" id="editors"></div>
    </div>

</div>      

  
<script>
    var _active_file = false;
    var editors = [];
    var tabs = [];
    var tabid = 0;
    var pathtotabid = [];
    var presavecontent = [];

    function buildtree(tree, depth=0, path = '') {
        var html = ''
        var icondir = '<i class="bi bi-folder"></i>';
        var iconfile = '<i class="bi bi-file"></i>';

        if (depth == 0) {
            html += ('<ul class="directorytree" id="collapsedirectory">')
        } else {
            html += ('<ul>')
        }
        
        for (name in tree) {
            var cls = '';
            if (tree[name]) {
                cls = ' class="directory"';
            }

            html += ('<li'+cls+'>')
            if (tree[name]) {
                html += '<div style="width:60%">' + icondir + name + '</div><div style="display:inline-block;text-align:right;"><i class="bi bi-folder-plus" onclick="addFolder(\''+path + name+'\')"></i> <i class="bi bi-file-plus" onclick="addFile(\''+path + name+'\')"></i></div>';
                html += buildtree(tree[name], depth+1, path + name+'/')
            } else {
                html += '<a href="#" onclick="editorLoadFile(\''+path + name+'\')" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" class="icon-link">'+iconfile + name+'</a>'
            }
            html += ('</li>')
        }
        html += ('</ul>')
        return html;
    } 

    api_request('getrepodetails', {'name': _active_repo}, function(response) {
        setTitle('[EDIT] ' + response.DATA.config.app.name);
    });

    api_request('getdirectory', {'name': _active_repo}, function(response) {
        $('#directory').html(buildtree(response.DATA));
        compactMenu('collapsedirectory',false,'');
    })

    function editorLoadFile(path) {
        $('#editorholder').removeClass('d-none');

        _active_file = path;
        api_request('getfilecontent', {'name': _active_repo, 'path': path}, function(response) {
            if (path in editors) {
                $('[href="#tab_'+pathtotabid[path]+'"]').tab('show');
            } else {
                tabid += 1;
                tabs[tabid] = path;
                var filename = path.replace(/^.*[\\\/]/, '')
                $('#editor_tabbar').append('<li class="nav-item"><a href="#tab_'+tabid+'" id="tabhead_'+tabid+'" class="nav-link" data-bs-toggle="tab" onclick="setActiveTab(\''+path+'\')"><span id="badge_'+tabid+'" class="badge text-bg-danger d-none">&nbsp;</span>&nbsp;'+filename+'<button type="button" class="btn-close d-inline" aria-label="Close" onclick="closeTab('+tabid+')"></button></a></li>')
                $('#editors').append('<div class="tab-pane active" id="tab_'+tabid+'"><textarea id="editor_'+tabid+'" style="width:100%;"></textarea></div>')
                editors[path] = CodeMirror.fromTextArea(document.getElementById('editor_'+tabid), {
                    mode: "python",
                    lineNumbers: true,
                    indentUnit: 4,
                    matchBrackets: true,
                    tabId: tabid,
                });
                editors[path].tabid = tabid;
                editors[path].setSize(null, 600);
                editors[path].save()    
                console.log(response.DATA)    
                if (response.DATA)    
                    editors[path].getDoc().setValue(response.DATA);
                presavecontent[path] = editors[_active_file].getValue();
                pathtotabid[path] = tabid;

                editors[path].on('change', function(e) {
                    var tid = e.options.tabId;
                    if (presavecontent[tabs[tid]] != editors[tabs[tid]].getValue()) {
                        $('#badge_'+tid).removeClass('d-none')
                    } else {
                        $('#badge_'+tid).addClass('d-none')
                    }
                })
                $('[href="#tab_'+tabid+'"]').tab('show');

            }
        })
    }

    function setActiveTab(path) {
        _active_file = path
    }


    function editorSaveFile() {
        api_request('savefilecontent', {'name': _active_repo, 'path': _active_file, 'content':editors[_active_file].getValue()}, function(response) {
            presavecontent[_active_file] = editors[_active_file].getValue();
            $('#badge_'+ pathtotabid[_active_file]).addClass('d-none');
        })
    }

    function closeTab(id) {
        $('#tabhead_'+id).remove();
        $('#tab_'+id).remove();
        path = tabs[id]


        delete presavecontent[path];
        delete editors[path];
        delete pathtotabid[path];
        delete tabs[path];        

        if ($("[id^=tabhead_]").length == 0) {
            $('#editorholder').addClass('d-none');
        }        

        for(n in tabs) {
            $('[href="#tab_'+pathtotabid[tabs[n]]+'"]').tab('show');
        }

    }


    function addFolder(path) {
        showModalInput('New Folder', 'Enter new folder name', function(reply) {
            api_request('createfolder', {'name': _active_repo, 'path': path + '/' + reply}, function(response) {
                api_request('getdirectory', {'name': _active_repo}, function(response) {
                    $('#directory').html(buildtree(response.DATA));
                    compactMenu('collapsedirectory',false,'');
                })                
            })
        });
    }
    
    function addFile(path) {
        showModalInput('New File', 'Enter new filename', function(reply) {
            api_request('createfile', {'name': _active_repo, 'path': path + '/' + reply}, function(response) {
                api_request('getdirectory', {'name': _active_repo}, function(response) {
                    $('#directory').html(buildtree(response.DATA));
                    compactMenu('collapsedirectory',false,'');
                })                
            })
        });
    }
    
</script>